name: Daily Clover Sync

on:
  schedule:
    # NOTE: "0 11 * * *" is 11:00 UTC, not 11:00 EST. Change if needed.
    - cron: "0 11 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: sync
    permissions:
      contents: read
    steps:
      - name: ðŸ“¥ Checkout code
        # actions/checkout@v4 pinned to v4.3.0
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: ðŸŸ¢ Setup Node.js
        # REPLACE <SETUP_NODE_V4_SHA> with a real v4 commit SHA (see below)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: "18"
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸ”„ Run Clover sync
        env:
          ZOHO_REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
          ZOHO_CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          ZOHO_CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}

          # Plano merchant
          PLANO_ID: ${{ secrets.PLANO_ID }}
          PLANO_API_KEY: ${{ secrets.PLANO_API_KEY }}
          PLANO_AIRTABLE_ID: ${{ secrets.PLANO_AIRTABLE_ID }}

          # Prattville 1 merchant
          PRATTVILLE_1_ID: ${{ secrets.PRATTVILLE_1_ID }}
          PRATTVILLE_1_API_KEY: ${{ secrets.PRATTVILLE_1_API_KEY }}
          PRATTVILLE_1_AIRTABLE_ID: ${{ secrets.PRATTVILLE_1_AIRTABLE_ID }}

          # Wetumpka merchant
          WETUMPKA_ID: ${{ secrets.WETUMPKA_ID }}
          WETUMPKA_API_KEY: ${{ secrets.WETUMPKA_API_KEY }}
          WETUMPKA_AIRTABLE_ID: ${{ secrets.WETUMPKA_AIRTABLE_ID }}

          # Montgomery merchant
          Montgomery_ID: ${{ secrets.MONTGOMERY_ID }}
          Montgomery_API_KEY: ${{ secrets.MONTGOMERY_API_KEY }}
          Montgomery_AIRTABLE_ID: ${{ secrets.MONTGOMERY_AIRTABLE_ID }}

          # Clanton merchant
          Clanton_ID: ${{ secrets.CLANTON_ID }}
          Clanton_API_KEY: ${{ secrets.CLANTON_API_KEY }}
          Clanton_AIRTABLE_ID: ${{ secrets.CLANTON_AIRTABLE_ID }}

          # Prattville 2 merchant
          Prattville_2_ID: ${{ secrets.PRATTVILLE_2_ID }}
          Prattville_2_API_KEY: ${{ secrets.PRATTVILLE_2_API_KEY }}
          Prattville_2_AIRTABLE_ID: ${{ secrets.PRATTVILLE_2_AIRTABLE_ID }}

          # Wetumpka LLC merchant
          WETUMPKA_LLC_ID: ${{ secrets.WETUMPKA_LLC_ID }}
          WETUMPKA_LLC_API_KEY: ${{ secrets.WETUMPKA_LLC_API_KEY }}
          WETUMPKA_LLC_AIRTABLE_ID: ${{ secrets.WETUMPKA_LLC_AIRTABLE_ID }}
        run: |
          echo "ðŸš€ Starting Clover sync at $(date)"
          node clover-sync.cjs
          echo "âœ… Sync completed at $(date)"

      - name: ðŸ“Š Upload sync results
        if: always()
        # actions/upload-artifact@v4 pinned to v4.6.2
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sync-results-${{ github.run_number }}
          path: |
            *.json
            *.log
          retention-days: 7
